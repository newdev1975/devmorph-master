#!/bin/sh
# Main DevMorph CLI Script
# Routes commands to appropriate modules

# Exit on error
set -e

# Source libraries with error handling
SCRIPT_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)"
LIB_DIR="$SCRIPT_DIR/workspace-manager/lib"

# Only source if files exist
if [ -f "$LIB_DIR/helpers.sh" ]; then
    . "$LIB_DIR/helpers.sh"
else
    # Define basic helper functions if helpers.sh is not available
    command_exists() {
        command -v "$1" >/dev/null 2>&1
    }
fi

if [ -f "$LIB_DIR/logger.sh" ]; then
    . "$LIB_DIR/logger.sh"
    # Initialize logging if logger is available
    if command_exists initialize_logger 2>/dev/null; then
        initialize_logger
    fi
else
    # Define basic logging functions if logger is not available
    log_info() { echo "INFO [$(basename "$0")] $1" >&2; }
    log_error() { echo "ERROR [$(basename "$0")] $1" >&2; }
    log_warn() { echo "WARN [$(basename "$0")] $1" >&2; }
fi

# Default values
COMMAND=""
SUBCOMMAND=""

# Function to display usage
usage() {
    log_info "Displaying usage information"
    echo "Usage: $0 (workspace) [subcommand] [options]"
    echo ""
    echo "Available modules:"
    echo "  workspace    Manage workspaces"
    echo ""
    echo "Use '$0 <module> --help' for more information about a module."
    exit 0
}

# Check if command is provided
if [ $# -eq 0 ]; then
    usage
fi

COMMAND="$1"
shift

# Validate command parameter
case "$COMMAND" in
    "workspace")
        if [ $# -eq 0 ]; then
            log_info "Displaying workspace usage information"
            echo "Usage: $0 workspace (create|start|stop|list|destroy|mode) [options]"
            echo ""
            echo "Available workspace commands:"
            echo "  create        Create a new workspace"
            echo "  start         Start a workspace"
            echo "  stop          Stop a workspace"
            echo "  list          List all workspaces"
            echo "  destroy       Destroy a workspace"
            echo "  mode          Manage workspace mode (set/show)"
            echo ""
            echo "Use '$0 workspace <command> --help' for more information about a command."
            exit 0
        fi
        
        SUBCOMMAND="$1"
        shift
        
        # Validate subcommand
        case "$SUBCOMMAND" in
            "create"|"start"|"stop"|"list"|"destroy"|"mode")
                log_info "Executing workspace $SUBCOMMAND command"
                
                # Validate that the target script exists
                target_script="$SCRIPT_DIR/workspace-$SUBCOMMAND.sh"
                if [ ! -f "$target_script" ]; then
                    log_error "Workspace command script does not exist: $target_script"
                    exit 1
                fi
                
                # Execute the target script with proper error handling
                if ! "$target_script" "$@"; then
                    log_error "Workspace command $SUBCOMMAND failed"
                    exit 1
                fi
                ;;
            *)
                log_error "Unknown workspace command '$SUBCOMMAND'. Available: create, start, stop, list, destroy, mode"
                echo "Use '$0 workspace --help' to see available commands." >&2
                exit 1
                ;;
        esac
        ;;
    "--help"|"-h")
        usage
        ;;
    *)
        log_error "Unknown command '$COMMAND'. Available: workspace"
        echo "Use '$0 --help' to see available commands." >&2
        exit 1
        ;;
esac